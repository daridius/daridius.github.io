---
import Layout from "../layouts/Layout.astro";
import StoryContainer from "../components/StoryContainer.astro";

// Import all slides
import IntroSlide from "../components/IntroSlide.astro";
import TotalsSlide from "../components/TotalsSlide.astro";
import RankingSlide from "../components/RankingSlide.astro";
import MostFrequentMessageSlide from "../components/MostFrequentMessageSlide.astro";
import TopWordsSlide from "../components/TopWordsSlide.astro";
import EmojiSlide from "../components/EmojiSlide.astro";
import MonthlyChartSlide from "../components/MonthlyChartSlide.astro";
import PeakDaySlide from "../components/PeakDaySlide.astro";
import SilenceStreakSlide from "../components/SilenceStreakSlide.astro";
import ActivityStreakSlide from "../components/ActivityStreakSlide.astro";
import OutroSlide from "../components/OutroSlide.astro";
---

<Layout title="Your WhatsApp Wrapped 2025">
    <main id="viewer-main" style="opacity: 0;">
        <StoryContainer>
            <IntroSlide />
            <TotalsSlide />
            <RankingSlide />
            <MostFrequentMessageSlide />
            <TopWordsSlide />
            <EmojiSlide />
            <MonthlyChartSlide />
            <PeakDaySlide />
            <SilenceStreakSlide />
            <ActivityStreakSlide />
            <OutroSlide />
        </StoryContainer>
    </main>

    <div
        id="error-screen"
        style="display: none; height: 100vh; background: #0b141a; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: sans-serif;"
    >
        <h1>Oops!</h1>
        <p>This Wrapped link is invalid or expired.</p>
        <a
            href="/upload"
            style="margin-top: 20px; color: #25D366; text-decoration: none; font-weight: bold;"
            >Create your own Wrapped</a
        >
    </div>
</Layout>

<script>
    import { decodeAndDecompress } from "../utils/compression";
    import { injectData } from "../utils/dynamicInjector";

    async function initViewer() {
        // Use hash fragment for static-safe routing
        let hash = window.location.hash.substring(1);

        if (!hash) {
            // Fallback: check if it's in the pathname (just in case they move to SSR later)
            const path = window.location.pathname;
            if (path.length > 2) {
                hash = path.startsWith("/v/")
                    ? path.substring(3)
                    : path.substring(1);
            }
        }

        if (!hash || hash === "v") {
            window.location.href = "/";
            return;
        }

        console.log("Decoding hash from fragment:", hash);
        const data = decodeAndDecompress(hash);

        if (data) {
            // Inject data into DOM elements
            injectData(data);

            // Show the story
            const main = document.getElementById("viewer-main");
            const error = document.getElementById("error-screen");
            if (main) main.style.opacity = "1";
            if (error) error.style.display = "none";
        } else {
            document.getElementById("error-screen")!.style.display = "flex";
            document.getElementById("viewer-main")!.style.display = "none";
        }
    }

    // Run as early as possible
    initViewer();
</script>

<style>
    main {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        transition: opacity 0.5s ease;
    }
</style>
