---

---

<div class="story-container">
    <slot />

    <div class="navigation-overlay">
        <div class="nav-left"></div>
        <div class="nav-right"></div>
    </div>
</div>

<script>
    import { gsap } from "gsap";

    class StoryController {
        slides: NodeListOf<HTMLElement>;
        currentIndex: number;
        isAnimating: boolean;

        constructor() {
            this.slides = document.querySelectorAll(".slide");
            this.currentIndex = 0;
            this.isAnimating = false;

            this.init();
        }

        init() {
            if (this.slides.length === 0) return;

            // Show first slide
            gsap.set(this.slides[0], { autoAlpha: 1, zIndex: 10 });
            this.activateSlide(0);

            // Bind events
            document
                .querySelector(".nav-right")
                ?.addEventListener("click", () => this.next());

            // Disable left click for prev
            // document.querySelector(".nav-left")?.addEventListener("click", () => this.prev());

            // Key navigation
            window.addEventListener("keydown", (e) => {
                if (
                    e.key === "ArrowRight" ||
                    e.key === "Space" ||
                    e.key === "Enter"
                )
                    this.next();
                // if (e.key === "ArrowLeft") this.prev();
            });
        }

        next() {
            if (this.isAnimating || this.currentIndex >= this.slides.length - 1)
                return;
            this.transition(this.currentIndex, this.currentIndex + 1);
        }

        prev() {
            if (this.isAnimating || this.currentIndex <= 0) return;
            this.transition(this.currentIndex, this.currentIndex - 1);
        }

        transition(fromIndex: number, toIndex: number) {
            this.isAnimating = true;
            const fromSlide = this.slides[fromIndex];
            const toSlide = this.slides[toIndex];

            this.currentIndex = toIndex;

            const tl = gsap.timeline({
                onComplete: () => {
                    this.isAnimating = false;
                    gsap.set(fromSlide, { autoAlpha: 0, zIndex: 0 });
                },
            });

            // Transition Animation
            tl.to(fromSlide, {
                duration: 0.5,
                opacity: 0,
                scale: 0.95,
                ease: "power2.inOut",
            });

            tl.set(toSlide, { autoAlpha: 1, zIndex: 10 }, "<");
            tl.fromTo(
                toSlide,
                { opacity: 0, scale: 1.05 },
                { duration: 0.5, opacity: 1, scale: 1, ease: "power2.out" },
                "<",
            );

            // Trigger activation for the new slide
            tl.add(() => {
                this.activateSlide(toIndex);
            }, "-=0.2");
        }

        activateSlide(index: number) {
            const slide = this.slides[index];
            // Dispatch event for the slide component to catch
            const event = new CustomEvent("slide-enter");
            slide.dispatchEvent(event);
        }
    }

    // Initialize on client side with delay for safety
    document.addEventListener("DOMContentLoaded", () => {
        setTimeout(() => new StoryController(), 100);
    });
</script>

<style>
    .story-container {
        width: 100vw;
        height: 100vh;
        position: relative;
        overflow: hidden;
    }

    .navigation-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        z-index: 50;
    }

    .nav-left,
    .nav-right {
        flex: 1;
        height: 100%;
        cursor: pointer;
    }
</style>
